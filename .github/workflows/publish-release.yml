name: Publish releases for IDeSyDe

on:
  release:
    types: [created]

jobs:
  publish-all:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - id: get_version
      uses: battila7/get-version-action@v2
    - uses: earthly/actions-setup@v1
      with:
        version: v0.7.8
    - name: Build everything
      run: |
        cd ${{ github.workspace }}
        earthly +dist-all --tag=${{ steps.get_version.outputs.version }}
    - name: Upload windows binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: "${{ github.workspace }}/dist/idesyde-${{ steps.get_version.outputs.version }}-x86_64-pc-windows-gnu.zip"
        asset_name: idesyde-${{ steps.get_version.outputs.version }}-x86_64-windows.zip
        tag: "${{ github.ref }}"
        overwrite: true
    - name: Upload linux binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: "${{ github.workspace }}/dist/idesyde-${{ steps.get_version.outputs.version }}-x86_64-unknown-linux-musl.zip"
        asset_name: idesyde-${{ steps.get_version.outputs.version }}-x86_64-linux.zip
        tag: "${{ github.ref }}"
        overwrite: true